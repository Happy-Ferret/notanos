<html>
	<head>
	<style>
		.terminal.cursor {
		   box-shadow: inset 0px 0px 2px 2px 
		}
	</style>
	<script>
	function ScreenBuffer(){this.data=[]}ScreenBuffer.EMPTY_CELL=[131840," "];ScreenBuffer.prototype.ondirty=function(a){};ScreenBuffer.prototype.cursorX=0;ScreenBuffer.prototype.cursorY=0;ScreenBuffer.prototype.update=function(a,b){var d=this.data[a]||(this.data[a]=[]);d.length=b.length;for(var e=0;e<b.length;e++)d[e]=b[e]?[b[e][0],b[e][1]]:null;this.ondirty(a)}; ScreenBuffer.prototype.toString=function(){for(var a=[],b=0;b<this.data.length;b++){var d=this.data[b],e="";if(d)for(var f=0;f<d.length;f++)e+=d[f]?d[f][1]:" ";a.push(e)}return a.join("\n")};ScreenBuffer.prototype.setCursor=function(a,b){this.cursorX=a;this.ondirty(this.cursorY);this.cursorY=b;this.ondirty(b)};ScreenBuffer.prototype.getRows=function(){return this.data.length};ScreenBuffer.prototype.getCols=function(a){return this.data[a]?this.data[a].length:0}; ScreenBuffer.prototype.setRows=function(a){this.data.length=a};ScreenBuffer.prototype.setCols=function(a,b){(this.data[a]||(this.data[a]=[])).length=b};ScreenBuffer.prototype.getCell=function(a,b){return this.data[a]&&this.data[a][b]||ScreenBuffer.EMPTY_CELL};ScreenBuffer.prototype.setCell=function(a,b,d){(this.data[a]||(this.data[a]=[]))[b]=d;this.ondirty(a)};ScreenBuffer.prototype.resize=function(a,b){this.setRows(a);for(var d=0;d<a;d++)this.setCols(d,b)}; ScreenBuffer.prototype.clone=function(){var a=new ScreenBuffer;a.setRows(this.getRows());a.setCursor(this.cursorX,this.cursorY);for(var b=0;b<this.data.length;b++)this.data[b]&&a.update(b,this.data[b]);return a};ScreenBuffer.prototype.getRow=function(a){return this.data[a]};"undefined"!=typeof module&&(module.exports=ScreenBuffer); void function(){function a(a,e){var f=a.clone();e.forEach(function(c){if("number"==typeof c)a.setRows(c);else if(2==c.length)a.setCursor(c[0],c[1]);else if(3==c.length)1==c[1]?a.update(c[0],f.getRow(c[2])):0===c[1]&&a.setCols(c[0],c[2]);else if(4==c.length){var e=c[0],k=c[1],h=c[2];c=b(c[3]);for(var g=0;g<h.length;g++)a.setCell(e,k+g,[c[g],h.charAt(g)])}})}function b(a){var b=[];a.split(",").forEach(function(a){a=a.split("*");for(var c=parseInt(a[1],10)||1,d=0;d<c;d++)b.push(parseInt(a[0],10))}); return b}"undefined"!=typeof module&&(module.exports=a);"undefined"!=typeof ScreenBuffer&&(ScreenBuffer.patch=a)}();
	</script>
	<script>
	var x11_colors = [
	"000000","800000","008000","808000","000080","800080","008080","c0c0c0","808080","ff0000","00ff00","ffff00","0000ff","ff00ff","00ffff","ffffff",
	"000000","00005f","000087","0000af","0000d7","0000ff","005f00","005f5f","005f87","005faf","005fd7","005fff","008700","00875f","008787","0087af",
	"0087d7","0087ff","00af00","00af5f","00af87","00afaf","00afd7","00afff","00d700","00d75f","00d787","00d7af","00d7d7","00d7ff","00ff00","00ff5f",
	"00ff87","00ffaf","00ffd7","00ffff","5f0000","5f005f","5f0087","5f00af","5f00d7","5f00ff","5f5f00","5f5f5f","5f5f87","5f5faf","5f5fd7","5f5fff","5f8700",
	"5f875f","5f8787","5f87af","5f87d7","5f87ff","5faf00","5faf5f","5faf87","5fafaf","5fafd7","5fafff","5fd700","5fd75f","5fd787","5fd7af","5fd7d7","5fd7ff",
	"5fff00","5fff5f","5fff87","5fffaf","5fffd7","5fffff","870000","87005f","870087","8700af","8700d7","8700ff","875f00","875f5f","875f87","875faf","875fd7",
	"875fff","878700","87875f","878787","8787af","8787d7","8787ff","87af00","87af5f","87af87","87afaf","87afd7","87afff","87d700","87d75f","87d787","87d7af",
	"87d7d7","87d7ff","87ff00","87ff5f","87ff87","87ffaf","87ffd7","87ffff","af0000","af005f","af0087","af00af","af00d7","af00ff","af5f00","af5f5f","af5f87","af5faf",
	"af5fd7","af5fff","af8700","af875f","af8787","af87af","af87d7","af87ff","afaf00","afaf5f","afaf87","afafaf","afafd7","afafff","afd700","afd75f","afd787","afd7af",
	"afd7d7","afd7ff","afff00","afff5f","afff87","afffaf","afffd7","afffff","d70000","d7005f","d70087","d700af","d700d7","d700ff","d75f00","d75f5f","d75f87",
	"d75faf","d75fd7","d75fff","d78700","d7875f","d78787","d787af","d787d7","d787ff","d7af00","d7af5f","d7af87","d7afaf","d7afd7","d7afff","d7d700","d7d75f",
	"d7d787","d7d7af","d7d7d7","d7d7ff","d7ff00","d7ff5f","d7ff87","d7ffaf","d7ffd7","d7ffff","ff0000","ff005f","ff0087","ff00af","ff00d7","ff00ff","ff5f00","ff5f5f",
	"ff5f87","ff5faf","ff5fd7","ff5fff","ff8700","ff875f","ff8787","ff87af","ff87d7","ff87ff","ffaf00","ffaf5f","ffaf87","ffafaf","ffafd7","ffafff","ffd700","ffd75f","ffd787",
	"ffd7af","ffd7d7","ffd7ff","ffff00","ffff5f","ffff87","ffffaf","ffffd7","ffffff","080808","121212","1c1c1c","262626","303030","3a3a3a","444444","4e4e4e","585858",
	"606060","666666","767676","808080","8a8a8a","949494","9e9e9e","a8a8a8","b2b2b2","bcbcbc","c6c6c6","d0d0d0","dadada","e4e4e4","eeeeee"];
	</script>
	<script>
	var keyCodeToAnsi = function (ev, opts) {
	    if (!opts) opts = {};
	    if (typeof ev === 'number') ev = { which: ev };
	    
	    var code = ev.which || ev.keyCode;
	    var c = String.fromCharCode(code);
	    
	    if (ev.shiftKey && ev.ctrlKey) return;
	    if (ev.ctrlKey && c === 'R') return; // pass ctrl-r through
	    if (ev.ctrlKey && c === 'L') return; // pass ctrl-l through

	    if (code < 32 && code !== 8 && !/\s/.test(c)) return;
	    
	    if (code >= 37 && code <= 40) {
		if (opts.arrows === false) return undefined;
		c = '\x1b[' + String.fromCharCode({
		    38: 65, 40: 66, 39: 67, 37: 68
		}[code]);
		return c;
	    }
	    else if (code === 33) return '\x1b[5~'; // pgup
	    else if (code === 34) return '\x1b[6~'; // pgdown
	    else if (code === 35) return '\x1bOF'; // end
	    else if (code === 36) return '\x1bOH'; // home
	    else if (code === 45) return '\x1b[2~'; // insert
	    else if (code === 46) return '\x1b[3~'; // delete
	    
	    if (/[A-Z]/.test(c) && ev.shiftKey === false) {
		c = c.toLowerCase();
	    }
	    else if (/\d/.test(c) && ev.shiftKey) {
		c = ')!@#$%^&*('.charAt(parseInt(c));
	    }
	    else {
		c = ({
		    173: [ '-', '_' ],
		    186: [ ';', ':' ],
		    187: [ '=', '+' ],
		    188: [ ',', '<' ],
		    189: [ '-', '_' ],
		    190: [ '.', '>' ],
		    191: [ '/', '?' ],
		    192: [ '`', '~' ],
		    219: [ '[', '{' ],
		    220: [ '\\', '|' ],
		    221: [ ']','}' ],
		    222: [ '\'', '"' ]
		}[code] || [ c, c ])[ev.shiftKey ? 1 : 0] || c;
	    }
	    
	    if (/^[a-z]$/.test(c) && ev.ctrlKey) {
		code = code - 64;
		c = String.fromCharCode(code);
	    }
	    if (code === 7 && opts['delete'] === false) return undefined;
	    if (code === 8 && opts.backspace === false) return undefined;
	    if (code === 13) return '\r\n';
	    return c;
	};
	function UTF8ArrToStr(aBytes) {
        var sView = "";

        for (var nPart, nLen = aBytes.length, nIdx = 0; nIdx < nLen; nIdx++) {
            nPart = aBytes[nIdx];
            sView += String.fromCharCode(
              nPart > 251 && nPart < 254 && nIdx + 5 < nLen ? /* six bytes */
                /* (nPart - 252 << 32) is not possible in ECMAScript! So...: */
                (nPart - 252) * 1073741824 + (aBytes[++nIdx] - 128 << 24) + (aBytes[++nIdx] - 128 << 18) + (aBytes[++nIdx] - 128 << 12) + (aBytes[++nIdx] - 128 << 6) + aBytes[++nIdx] - 128
              : nPart > 247 && nPart < 252 && nIdx + 4 < nLen ? /* five bytes */
                (nPart - 248 << 24) + (aBytes[++nIdx] - 128 << 18) + (aBytes[++nIdx] - 128 << 12) + (aBytes[++nIdx] - 128 << 6) + aBytes[++nIdx] - 128
              : nPart > 239 && nPart < 248 && nIdx + 3 < nLen ? /* four bytes */
                (nPart - 240 << 18) + (aBytes[++nIdx] - 128 << 12) + (aBytes[++nIdx] - 128 << 6) + aBytes[++nIdx] - 128
              : nPart > 223 && nPart < 240 && nIdx + 2 < nLen ? /* three bytes */
                (nPart - 224 << 12) + (aBytes[++nIdx] - 128 << 6) + aBytes[++nIdx] - 128
              : nPart > 191 && nPart < 224 && nIdx + 1 < nLen ? /* two bytes */
                (nPart - 192 << 6) + aBytes[++nIdx] - 128
              : /* nPart < 127 ? */ /* one byte */
                nPart
            );
          }

        return sView;
    }
	var display=new ScreenBuffer();
	
	var loc=window.parent.location; 
	var parentOrigin= loc.protocol+'//'+loc.hostname+(loc.port ? ':'+loc.port: '');
	function sendData(data) {
		window.parent.postMessage({"messageType" : "hostmessage", "data" : data},parentOrigin);		
	}
	addEventListener("message",handleMessage,false);
	function handleMessage(e) {
		var text=UTF8ArrToStr(new Uint8Array(e.data.data)).split('/n')[0]; // losing big packets here - fix.		
		var obj=JSON.parse(text);
		ScreenBuffer.patch(display,obj);
		updateDisplay();	
	}

       function updateDisplay() {
      		var out = document.getElementById("output");
		var s= "";
		for (var ty=0; ty<display.getRows(); ty++) {
			for ( var tx=0; tx<display.getCols(ty); tx++ ) {
			   var cell=display.getCell(ty,tx);
			   var fg=(cell[0]>>9) & 0x1ff;
			   var bg=(cell[0]>>0) & 0x1ff;
			   if (fg >255) fg= (fg==256) ?15:0;
			   if (bg >255) bg= (bg==256) ?15:0;
			   var iv=(cell[0]>>20) & 0x1;
			   var ul=(cell[0]>>19) & 0x1;
			   var b=(cell[0]>>18) & 0x1;
			   if (iv==1) {
				var hold = fg;
				fg=bg;
				bg=hold;
			   }
			   var cellClass="terminal";
			   if (ul == 1) cellClass+=" underline";
			   if (b == 1) cellClass+=" bold";
			   if (tx===display.cursorX  & ty===display.cursorY) cellClass+=" cursor";
			   if (b == 1) cellClass+=" bold";
			   var fgtext= "color:#"+ x11_colors[fg];
			   var bgtext= "background-color:#"+ x11_colors[bg];
			   
			   s+='<span class="'+cellClass+'"style="'+fgtext+';'+bgtext+'">'+cell[1]+"</span>";
			}s+="\n";
			
		}
		out.innerHTML=s;
		
       }
	document.addEventListener("keydown",
		function(e) {
			var ansi=keyCodeToAnsi(e);
			if (ansi){
			  sendData(ansi);
			}
		
			e.preventDefault();
			e.stopPropagation();
		}, 
		false);
	</script>
	</head>	
	<body>
		<pre id="output"></pre>
	</body>
</html>